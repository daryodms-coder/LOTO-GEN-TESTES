<!DOCTYPE html>
<html lang="pt-BR" data-bs-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerador e Analisador de Loterias</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- jsPDF for PDF Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas for PNG Export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        /* CSS Variables for dynamic theming */
        :root {
            --primary-color: #0d6efd;
            --primary-hover-color: #0b5ed7;
        }

        body {
            background-color: #2b3035;
        }

        .card-header, .btn-primary {
            background-color: var(--primary-color) !important;
            border-color: var(--primary-color) !important;
        }

        .btn-primary:hover {
            background-color: var(--primary-hover-color) !important;
            border-color: var(--primary-hover-color) !important;
        }
        
        .btn-outline-primary {
            color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-outline-primary:hover, .btn-check:checked+.btn-outline-primary, .number-btn.active {
            color: #fff;
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .number-btn {
            font-weight: 600;
            width: 40px;
            height: 40px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            border-radius: 50%;
            position: relative;
        }

        .number-btn:hover {
            transform: scale(1.1);
            z-index: 1;
        }
        
        .btn-fixed {
            background-color: #198754 !important; /* Bootstrap success green */
            border-color: #146c43 !important;
            color: white !important;
        }

        .btn-fixed .fa-thumbtack {
            position: absolute;
            top: 2px;
            right: 2px;
            font-size: 0.6em;
            color: rgba(255, 255, 255, 0.7);
        }

        .selected-numbers {
            min-height: 60px;
            padding: 10px;
            background-color: #212529;
            border-radius: 8px;
        }
        
        #selectionCardBody, #analysisCardBody {
            background-color: #343a40; /* Lighter background for selection area */
        }

        #numberGridContainer {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(45px, 1fr));
            gap: 0.5rem;
        }

        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }

        .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
        }

        .btn {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }

        .text-bronze {
            color: #cd7f32 !important;
        }

        /* Super Sete Styles */
        #superSeteGridContainer {
            display: flex;
            justify-content: space-around;
            gap: 10px;
        }
        .super-sete-column {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        .super-sete-column .number-btn {
            width: 35px;
            height: 35px;
            font-size: 0.9rem;
            border-radius: 8px;
        }
        .nav-tabs .nav-link {
            color: #ccc;
        }
        .nav-tabs .nav-link.active {
            color: #fff;
            background-color: #343a40;
            border-color: #454d55 #454d55 #343a40;
        }
        .nav-tabs .nav-link:hover {
            border-color: #454d55;
        }
        .suggestion-numbers {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-top: 10px;
        }
        #copyNotification {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1050;
            transition: opacity 0.5s ease-in-out;
        }
        
        /* Novos estilos adicionados */
        .hot-number {
            box-shadow: 0 0 8px 2px rgba(255, 50, 50, 0.7) !important;
            animation: pulse-hot 2s infinite;
        }

        .cold-number {
            box-shadow: 0 0 8px 2px rgba(50, 150, 255, 0.7) !important;
            animation: pulse-cold 2s infinite;
        }

        @keyframes pulse-hot {
            0% { box-shadow: 0 0 8px 2px rgba(255, 50, 50, 0.7); }
            50% { box-shadow: 0 0 12px 4px rgba(255, 50, 50, 0.9); }
            100% { box-shadow: 0 0 8px 2px rgba(255, 50, 50, 0.7); }
        }

        @keyframes pulse-cold {
            0% { box-shadow: 0 0 8px 2px rgba(50, 150, 255, 0.7); }
            50% { box-shadow: 0 0 12px 4px rgba(50, 150, 255, 0.9); }
            100% { box-shadow: 0 0 8px 2px rgba(50, 150, 255, 0.7); }
        }
        
        .number-btn, .card, .btn {
            transition: all 0.3s ease;
        }

        .selected-numbers, #resultsSection {
            transition: opacity 0.4s ease, transform 0.4s ease;
        }
    </style>
</head>

<body>
    <header class="bg-dark shadow-sm pb-2">
        <div class="container">
            <div class="d-flex flex-wrap align-items-center justify-content-center justify-content-lg-start">
                <a class="navbar-brand d-flex align-items-center mb-2 mb-lg-0 me-lg-auto text-white text-decoration-none" href="#">
                    <i class="fas fa-ticket-alt me-2"></i> Gerador & Analisador
                </a>

                <div class="ms-lg-3">
                    <select id="gameModeSelect" class="form-select bg-dark text-white">
                        <option value="lotofacil">Lotofácil</option>
                        <option value="megasena">Mega-Sena</option>
                        <option value="maismilionaria">Mais Milionária</option>
                        <option value="quina">Quina</option>
                        <option value="lotomania">Lotomania</option>
                        <option value="timemania">Timemania</option>
                        <option value="duplasena">Dupla Sena</option>
                        <option value="diadesorte">Dia de Sorte</option>
                        <option value="supersete">Super Sete</option>
                    </select>
                </div>
                <div class="ms-2">
                    <button id="resetAllBtn" class="btn btn-outline-warning">
                        <i class="fas fa-redo me-1"></i> Limpar Tudo
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="container mt-4">
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="generator-tab" data-bs-toggle="tab" data-bs-target="#generator-tab-pane" type="button" role="tab"><i class="fas fa-random me-1"></i> Gerador</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="analysis-tab" data-bs-toggle="tab" data-bs-target="#analysis-tab-pane" type="button" role="tab"><i class="fas fa-chart-bar me-1"></i> Análise</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming-tab-pane" type="button" role="tab"><i class="fas fa-calendar-alt me-1"></i> Próximos Concursos</button>
            </li>
        </ul>

        <div class="tab-content" id="mainTabContent">
            <!-- Generator Pane -->
            <div class="tab-pane fade show active" id="generator-tab-pane" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header text-white">
                                <h4 class="mb-0"><i class="fas fa-random me-2"></i>Gerador de Apostas: <span class="gameNameHeader"></span></h4>
                            </div>
                            <div class="card-body" id="selectionCardBody">
                                <div id="rulesAlert" class="alert alert-info" role="alert"></div>
                                <div id="specialSelectionContainer" class="mb-3"></div>
                                <div class="mb-4">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <h5 id="selectionHeader" class="mb-0"><i class="fas fa-th me-2"></i>Selecione seus números</h5>
                                    </div>
                                    <div id="numberGridContainer" class="number-grid"></div>
                                    <div id="superSeteGridContainer" class="d-none"></div>
                                    <div class="d-flex justify-content-end mt-3">
                                        <button id="clearBtn" class="btn btn-outline-danger"><i class="fas fa-trash-alt me-1"></i> Limpar Seleção</button>
                                        <button id="selectAllBtn" class="btn btn-outline-secondary ms-2">
                                            <i class="fas fa-check-square me-1"></i> Selecionar Tudo
                                        </button>
                                    </div>
                                </div>
                                <div class="selected-numbers mb-4">
                                    <h5><i class="fas fa-check-circle me-2"></i>Números Selecionados</h5>
                                    <div id="selectedNumbersList" class="d-flex flex-wrap align-items-center gap-1">
                                        <span class="text-muted">Nenhum número selecionado</span>
                                    </div>
                                </div>
                                <div id="generationModeContainer" class="mb-4">
                                    <h5><i class="fas fa-cogs me-2"></i>Modo de Geração</h5>
                                    <div class="btn-group w-100" role="group">
                                        <input type="radio" class="btn-check" name="generationMode" id="modeFechamento" value="fechamento" autocomplete="off" checked>
                                        <label class="btn btn-outline-secondary" for="modeFechamento">Fechamento Completo</label>
                                        <input type="radio" class="btn-check" name="generationMode" id="modeFixo" value="fixo" autocomplete="off">
                                        <label class="btn btn-outline-secondary" for="modeFixo">Com Dezenas Fixas</label>
                                    </div>
                                    <div id="fixedNumbersInfo" class="form-text mt-2 d-none">
                                        Clique uma vez em um número para selecionar. Clique uma segunda vez para fixá-lo (verde). Um terceiro clique desmarca.
                                    </div>
                                </div>
                                <div class="d-grid gap-2">
                                    <button id="generateBtn" class="btn btn-primary btn-lg"><i class="fas fa-cogs me-2"></i>Gerar Combinações</button>
                                </div>
                            </div>
                        </div>
                        <div id="resultsSection" class="card mt-4 d-none">
                            <div class="card-header bg-success text-white">
                                <h4 class="mb-0"><i class="fas fa-list-ol me-2"></i>Combinações Geradas</h4>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-light mb-4">
                                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                                        <div>
                                            <h5 class="mb-1">Resumo</h5>
                                            <p class="mb-0" id="totalCombinations"></p>
                                            <p class="mb-0" id="totalCost"></p>
                                        </div>
                                        <div class="d-flex gap-2">
                                            <button class="btn btn-outline-info" id="copyGamesBtn"><i class="fas fa-copy me-1"></i> Copiar Jogos</button>
                                            <div class="dropdown">
                                                <button class="btn btn-outline-success dropdown-toggle" type="button" id="exportDropdown" data-bs-toggle="dropdown"><i class="fas fa-download me-1"></i> Exportar</button>
                                                <ul class="dropdown-menu">
                                                    <li><a class="dropdown-item" href="#" id="exportCsv">CSV</a></li>
                                                    <li><a class="dropdown-item" href="#" id="exportTxt">TXT</a></li>
                                                    <li><a class="dropdown-item" href="#" id="exportPdf">PDF (Volantes)</a></li>
                                                    <li><a class="dropdown-item" href="#" id="exportPng">PNG (Imagem)</a></li>
                                                </ul>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover">
                                        <thead><tr><th>#</th><th>Números</th></tr></thead>
                                        <tbody id="combinationsTable"></tbody>
                                    </table>
                                </div>
                                <div id="checkHistoryBtnContainer" class="d-flex flex-wrap gap-2 mt-3 d-none">
                                    <button id="checkHistoryBtn" class="btn btn-outline-warning flex-grow-1" data-bs-toggle="modal" data-bs-target="#historyModal"><i class="fas fa-history me-2"></i> Analisar por Concurso</button>
                                    <button id="checkRangeHistoryBtn" class="btn btn-outline-info flex-grow-1" data-bs-toggle="modal" data-bs-target="#rangeHistoryModal"><i class="fas fa-search-plus me-2"></i> Analisar entre Concursos</button>
                                </div>
                            </div>
                            <div id="resultCheckerSection" class="card-footer d-none">
                                <h5 class="mb-3"><i class="fas fa-check-double me-2"></i>Conferir Resultado Manualmente</h5>
                                <div class="mb-3">
                                    <label for="drawnNumbersInput" class="form-label">Digite os números sorteados (separados por vírgula ou espaço):</label>
                                    <input type="text" class="form-control" id="drawnNumbersInput" placeholder="Ex: 1, 2, 3, 4, 5, 6">
                                </div>
                                <div id="specialCheckerContainer" class="mb-3 d-none"></div>
                                <button id="checkResultsBtn" class="btn btn-success"><i class="fas fa-search me-1"></i> Conferir</button>
                                <div id="prizeSummary" class="mt-3 d-none">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <h6><i class="fas fa-trophy me-1"></i> Resumo da Premiação</h6>
                                            <ul id="prizeList" class="list-group"></ul>
                                        </div>
                                        <div class="col-md-6 mt-3 mt-md-0">
                                            <h6><i class="fas fa-dollar-sign me-1"></i> Análise Financeira</h6>
                                            <ul id="financialSummaryList" class="list-group"></ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Analysis Pane -->
            <div class="tab-pane fade" id="analysis-tab-pane" role="tabpanel">
                 <div class="row mt-3">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                             <div class="card-header text-white">
                                <h4 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Análise de Frequência: <span class="gameNameHeader"></span></h4>
                            </div>
                            <div class="card-body" id="analysisCardBody">
                                <div class="row align-items-end">
                                    <div class="col-md-6">
                                        <label for="contestCountInput" class="form-label">Analisar os últimos concursos:</label>
                                        <input type="number" class="form-control" id="contestCountInput" value="100" min="10" max="5000">
                                    </div>
                                    <div class="col-md-6 d-grid">
                                        <button id="runAnalysisBtn" class="btn btn-warning mt-3 mt-md-0"><i class="fas fa-cogs me-2"></i>Analisar Concursos</button>
                                    </div>
                                </div>
                            </div>
                            <div id="analysisResultsContainer" class="card-body" style="display: none;">
                                <!-- Analysis results will be injected here -->
                            </div>
                            <div id="analysisLoadingSpinner" class="card-body text-center" style="display: none;">
                                <div class="spinner-border text-warning" role="status"></div>
                                <p class="mt-2">Buscando e analisando dados... Isso pode levar um momento.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Upcoming Contests Pane -->
            <div class="tab-pane fade" id="upcoming-tab-pane" role="tabpanel">
                <div class="row mt-3">
                    <div class="col-lg-8 mx-auto">
                        <div class="card">
                            <div class="card-header text-white">
                                <h4 class="mb-0"><i class="fas fa-calendar-alt me-2"></i>Informações dos Próximos Concursos</h4>
                            </div>
                            <div class="card-body" id="upcomingContestsContainer">
                                <!-- Conteúdo dos próximos concursos será carregado aqui via JS -->
                                <div class="text-center">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Carregando...</span>
                                    </div>
                                    <p class="mt-2">Carregando informações...</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Global Loading Spinner & Error Alert -->
        <div class="row mt-3">
            <div class="col-lg-8 mx-auto">
                <div id="loadingSpinner" class="text-center my-5 d-none">
                    <div class="spinner-border text-primary" style="width: 3rem; height: 3rem;" role="status">
                        <span class="visually-hidden">Carregando...</span>
                    </div>
                    <p class="mt-2 fs-5">Gerando combinações...</p>
                </div>
                <div id="errorAlert" class="alert alert-danger mt-4 d-none" role="alert">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <span id="errorMessage"></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal fade" id="historyModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-history me-2"></i>Análise por Concurso</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Digite o número de um concurso anterior ou busque o mais recente para verificar o desempenho das suas apostas.</p>
                    <div class="input-group mb-3">
                        <input type="number" id="contestNumberInput" class="form-control" placeholder="Número do concurso">
                        <button class="btn btn-outline-secondary" type="button" id="fetchLatestContestBtn">
                            <span class="spinner-border spinner-border-sm d-none" role="status"></span> Buscar Último
                        </button>
                    </div>
                     <div class="d-grid">
                        <button class="btn btn-warning" type="button" id="analyzeContestBtn">
                            <i class="fas fa-search me-1"></i> Analisar Concurso
                        </button>
                    </div>
                    <div id="historyAnalysisResult" class="mt-4 d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="rangeHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title"><i class="fas fa-search-plus me-2"></i>Análise entre Concursos</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Digite o intervalo de concursos (inicial e final) para verificar o desempenho das suas apostas.</p>
                    <div class="row g-3 align-items-center">
                        <div class="col-md-5">
                            <input type="number" id="startContestInput" class="form-control" placeholder="Concurso Inicial">
                        </div>
                        <div class="col-md-5">
                            <input type="number" id="endContestInput" class="form-control" placeholder="Concurso Final">
                        </div>
                        <div class="col-md-2 d-grid">
                            <button class="btn btn-info" type="button" id="analyzeRangeBtn">
                                <i class="fas fa-play me-1"></i> Analisar
                            </button>
                        </div>
                    </div>
                    <div id="rangeHistoryAnalysisResult" class="mt-4 d-none"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Copy Notification -->
    <div id="copyNotification" class="alert alert-success d-none" role="alert">
        <i class="fas fa-check-circle me-2"></i> Jogos copiados para a área de transferência!
    </div>

    <footer class="bg-dark text-light mt-5 py-4">
        <div class="container text-center">
            <p class="small mb-1">
                Esta é uma ferramenta de apoio e não garante prêmios. Jogue com responsabilidade.
            </p>
            <p class="small text-muted mb-0">
                Valores de prêmios são estimativas e podem variar.
            </p>
        </div>
    </footer>

    <!-- Bootstrap JS Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Custom JS -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- CONFIGS ---
            const lotteryConfigs = {
                lotofacil: {
                    displayName: "Lotofácil", apiName: "lotofacil", fallbackSlug: 'lotofacil', totalNumbers: 25, betSize: 15, minSelection: 15, maxSelection: 20, cost: 3.00, color: '#930089', hoverColor: '#7a0070', pdfGridCols: 5, prizeTiers: [15, 14, 13, 12, 11], prizeValues: { 11: 6.00, 12: 12.00, 13: 30.00, 14: 1500.00, 15: 1700000.00 }
                },
                megasena: {
                    displayName: "Mega-Sena", apiName: "megasena", fallbackSlug: 'mega-sena', totalNumbers: 60, betSize: 6, minSelection: 6, maxSelection: 20, cost: 5.00, color: '#209869', hoverColor: '#197c56', pdfGridCols: 10, prizeTiers: [6, 5, 4], prizeValues: { 4: 900.00, 5: 45000.00, 6: 30000000.00 }
                },
                maismilionaria: {
                    displayName: "Mais Milionária", apiName: "maismilionaria", fallbackSlug: 'mais-milionaria', totalNumbers: 50, betSize: 6, minSelection: 6, maxSelection: 12, cost: 6.00, color: '#007bff', hoverColor: '#0056b3', pdfGridCols: 10, hasTrevos: true, trevoSize: 2, prizeTiers: ['6+2', '6+1', '5+2', '5+1', '4+2', '4+1', '3+2', '3+1', '2+2', '2+1'], prizeValues: { '6+2': 10000000, '6+1': 500000, '5+2': 50000, '5+1': 1000, '4+2': 1000, '4+1': 100, '3+2': 50, '3+1': 24, '2+2': 12, '2+1': 6 }
                },
                quina: {
                    displayName: "Quina", apiName: "quina", fallbackSlug: 'quina', totalNumbers: 80, betSize: 5, minSelection: 5, maxSelection: 15, cost: 2.50, color: '#260085', hoverColor: '#1e006a', pdfGridCols: 10, prizeTiers: [5, 4, 3, 2], prizeValues: { 2: 4.00, 3: 150.00, 4: 7000.00, 5: 1500000.00 }
                },
                lotomania: {
                    displayName: "Lotomania", apiName: "lotomania", fallbackSlug: 'lotomania', totalNumbers: 100, betSize: 50, minSelection: 50, maxSelection: 50, cost: 3.00, color: '#f78100', hoverColor: '#c46600', pdfGridCols: 10, prizeTiers: [20, 19, 18, 17, 16, 15, 0], prizeValues: { 15: 10.00, 16: 50.00, 17: 200.00, 18: 1500.00, 19: 50000.00, 20: 1000000.00, 0: 100000.00 }
                },
                timemania: {
                    displayName: "Timemania", apiName: "timemania", fallbackSlug: 'timemania', totalNumbers: 80, betSize: 10, minSelection: 10, maxSelection: 10, cost: 3.50, color: '#008000', hoverColor: '#005300', pdfGridCols: 10, hasTeam: true, prizeTiers: [7, 6, 5, 4, 3], prizeValues: { 3: 5.00, 4: 10.00, 5: 25.00, 6: 1000.00, 7: 25000.00, "team": 8.50 }
                },
                duplasena: {
                    displayName: "Dupla Sena", apiName: "duplasena", fallbackSlug: 'dupla-sena', totalNumbers: 50, betSize: 6, minSelection: 6, maxSelection: 15, cost: 2.50, color: '#a50000', hoverColor: '#7d0000', pdfGridCols: 10, prizeTiers: [6, 5, 4, 3], prizeValues: { 3: 2.50, 4: 100.00, 5: 4000.00, 6: 200000.00 }
                },
                diadesorte: {
                    displayName: "Dia de Sorte", apiName: "diadesorte", fallbackSlug: 'dia-de-sorte', totalNumbers: 31, betSize: 7, minSelection: 7, maxSelection: 15, cost: 2.50, color: '#f8a700', hoverColor: '#c58400', pdfGridCols: 7, hasMonth: true, prizeTiers: [7, 6, 5, 4], prizeValues: { 4: 5.00, 5: 25.00, 6: 2000.00, 7: 300000.00, "month": 2.50 }
                },
                supersete: {
                    displayName: "Super Sete", apiName: "supersete", fallbackSlug: 'super-sete', totalNumbers: 10, betSize: 7, minSelection: 7, maxSelection: 21, cost: 2.50, color: '#8a2be2', hoverColor: '#6921b2', isColumnar: true, prizeTiers: [7, 6, 5, 4, 3], prizeValues: { 3: 5.00, 4: 50.00, 5: 1000.00, 6: 15000.00, 7: 500000.00 }
                }
            };
            const TEAMS = ["ABC/RN", "Altos/PI", "América/MG", "América/RN", "Aparecidense/GO", "Athletico/PR", "Atlético/AC", "Atlético/CE", "Atlético/GO", "Atlético/MG", "Avaí/SC", "Bahia/BA", "Boavista/RJ", "Botafogo/PB", "Botafogo/RJ", "Botafogo/SP", "Bragantino/SP", "Brasil de Pelotas/RS", "Brasiliense/DF", "Brusque/SC", "Campinense/PB", "Caxias/RS", "Ceará/CE", "Chapecoense/SC", "Cianorte/PR", "Confiança/SE", "Corinthians/SP", "Coritiba/PR", "CRB/AL", "Criciúma/SC", "Cruzeiro/MG", "CSA/AL", "Cuiabá/MT", "Ferroviária/SP", "Ferroviário/CE", "Figueirense/SC", "Flamengo/RJ", "Floresta/CE", "Fluminense/RJ", "Fortaleza/CE", "Goiás/GO", "Grêmio/RS", "Guarani/SP", "Imperatriz/MA", "Internacional/RS", "Ituano/SP", "Jacuipense/BA", "Joinville/SC", "Juazeirense/BA", "Juventude/RS", "Londrina/PR", "Luverdense/MT", "Manaus/AM", "Mirassol/SP", "Moto Club/MA", "Náutico/PE", "Novorizontino/SP", "Oeste/SP", "Operário/PR", "Palmeiras/SP", "Paraná/PR", "Paysandu/PA", "Ponte Preta/SP", "Portuguesa/SP", "Remo/PA", "Sampaio Corrêa/MA", "Santa Cruz/PE", "Santo André/SP", "Santos/SP", "São Bento/SP", "São José/RS", "São Paulo/SP", "São Raimundo/RR", "Sport/PE", "Tombense/MG", "Treze/PB", "Vasco/RJ", "Vila Nova/GO", "Vitória/BA", "Volta Redonda/RJ", "Ypiranga/RS"];
            const MONTHS = ["Janeiro", "Fevereiro", "Março", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro"];
            const MAX_COMBINATIONS = 50000;

            // --- API ---
            let localDatabase = null;

            async function fetchLocalDatabase() {
                if (localDatabase) {
                    return localDatabase;
                }
                try {
                    const response = await fetch('db.json');
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    localDatabase = await response.json();
                    return localDatabase;
                } catch (error) {
                    console.error('Failed to load local database:', error);
                    return null;
                }
            }

            async function searchLocalDatabase(gameMode, contestNumber) {
                const db = await fetchLocalDatabase();
                if (!db || !db[gameMode]) {
                    return null;
                }
                const contestNum = parseInt(contestNumber, 10);
                const result = db[gameMode].find(contest => contest.numero === contestNum);
                return result || null;
            }

            async function getLatestContestFromLocalDB(gameMode) {
                const db = await fetchLocalDatabase();
                if (!db || !db[gameMode] || db[gameMode].length === 0) {
                    return null;
                }
                return db[gameMode].reduce((latest, current) => (current.numero > latest.numero ? current : latest));
            }

            async function getContestsForAnalysisFromLocalDB(gameMode, count) {
                const db = await fetchLocalDatabase();
                if (!db || !db[gameMode] || db[gameMode].length === 0) {
                    return [];
                }
                return db[gameMode]
                    .sort((a, b) => b.numero - a.numero)
                    .slice(0, count);
            }
            
            async function getContestsForAnalysisFromLocalDBByRange(gameMode, start, end) {
                const db = await fetchLocalDatabase();
                if (!db || !db[gameMode] || db[gameMode].length === 0) {
                    return [];
                }
                return db[gameMode].filter(contest => contest.numero >= start && contest.numero <= end)
                                        .sort((a, b) => a.numero - b.numero);
            }

            async function fetchApiData(url) {
                const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                if (!response.ok) throw new Error('A resposta da rede não foi OK.');
                return response.json();
            }

            // --- UI ---
            function applyThemeColor(color, hoverColor) {
                document.documentElement.style.setProperty('--primary-color', color);
                document.documentElement.style.setProperty('--primary-hover-color', hoverColor);
            }

            function initializeNumberGrid(totalNum, container, clickHandler) {
                container.innerHTML = '';
                for (let i = 1; i <= totalNum; i++) {
                    const button = document.createElement('button');
                    button.className = 'btn btn-outline-primary number-btn';
                    button.dataset.number = i;
                    button.innerHTML = `<span>${i.toString().padStart(2, '0')}</span>`;
                    button.addEventListener('click', clickHandler);
                    container.appendChild(button);
                }
            }

            function initializeSuperSeteGrid(container, clickHandler) {
                container.innerHTML = '';
                for (let col = 0; col < 7; col++) {
                    const colDiv = document.createElement('div');
                    colDiv.className = 'super-sete-column';
                    colDiv.innerHTML = `<h6>Col ${col + 1}</h6>`;
                    for (let num = 0; num < 10; num++) {
                        const button = document.createElement('button');
                        button.className = 'btn btn-outline-primary number-btn';
                        button.dataset.number = num;
                        button.dataset.column = col;
                        button.innerHTML = `<span>${num}</span>`;
                        button.addEventListener('click', clickHandler);
                        colDiv.appendChild(button);
                    }
                    container.appendChild(colDiv);
                }
            }

            function buildSpecialSelectors(config, container, trevoClickHandler) {
                container.innerHTML = '';
                if (config.hasTeam) {
                    let html = `<label for="teamSelect" class="form-label">Time do Coração</label><select id="teamSelect" class="form-select">`;
                    TEAMS.sort().forEach(team => html += `<option value="${team}">${team}</option>`);
                    html += `</select>`;
                    container.innerHTML = html;
                }
                if (config.hasMonth) {
                    let html = `<label for="monthSelect" class="form-label">Mês da Sorte</label><select id="monthSelect" class="form-select">`;
                    MONTHS.forEach(month => html += `<option value="${month}">${month}</option>`);
                    html += `</select>`;
                    container.innerHTML = html;
                }
                if (config.hasTrevos) {
                    let html = `<h5 class="mt-3"><i class="fas fa-clover me-2"></i>Selecione 2 Trevos da Sorte</h5><div class="d-flex gap-2">`;
                    for (let i = 1; i <= 6; i++) {
                        html += `<button class="btn btn-outline-success number-btn trevo-btn" data-trevo="${i}">${i}</button>`;
                    }
                    html += `</div>`;
                    container.innerHTML = html;
                    document.querySelectorAll('.trevo-btn').forEach(btn => btn.addEventListener('click', trevoClickHandler));
                }
            }

            function buildSpecialCheckers(config, container) {
                container.innerHTML = '';
                container.classList.add('d-none');
                if (config.hasTrevos) {
                    container.innerHTML = `<label for="drawnTrevosInput" class="form-label">Digite os trevos sorteados:</label><input type="text" class="form-control" id="drawnTrevosInput" placeholder="Ex: 1, 2">`;
                    container.classList.remove('d-none');
                }
                if (config.hasMonth) {
                    container.innerHTML = `<label for="drawnMonthInput" class="form-label">Digite o Mês da Sorte:</label><input type="text" class="form-control" id="drawnMonthInput" placeholder="Ex: Janeiro">`;
                    container.classList.remove('d-none');
                }
                if (config.hasTeam) {
                    container.innerHTML = `<label for="drawnTeamInput" class="form-label">Digite o Time do Coração sorteado:</label><input type="text" class="form-control" id="drawnTeamInput" placeholder="Ex: Flamengo/RJ">`;
                    container.classList.remove('d-none');
                }
            }
            
            function updateSelectedNumbersDisplay(selectedNumbers, fixedNumbers, superSeteSelections, selectedTrevos, config) {
                const selectedNumbersList = document.getElementById('selectedNumbersList');
                selectedNumbersList.innerHTML = '';
                
                let currentSelections = config.isColumnar ? superSeteSelections.flat() : selectedNumbers;

                if (currentSelections.length === 0 && selectedTrevos.length === 0) {
                    selectedNumbersList.innerHTML = '<span class="text-muted">Nenhum número selecionado</span>';
                    return;
                }
                
                if (config.isColumnar) {
                    superSeteSelections.forEach((col, colIndex) => {
                        if (col.length > 0) {
                            const badge = document.createElement('span');
                            badge.className = 'badge bg-secondary me-2 mb-1';
                            badge.innerHTML = `<strong>Col ${colIndex + 1}:</strong> ${col.join(', ')}`;
                            selectedNumbersList.appendChild(badge);
                        }
                    });
                } else {
                    selectedNumbers.forEach(number => {
                        const isFixed = fixedNumbers.includes(number);
                        const badge = document.createElement('span');
                        badge.className = `badge me-1 mb-1 fs-6 ${isFixed ? 'bg-success' : ''}`;
                        if (!isFixed) badge.style.backgroundColor = config.color;
                        badge.textContent = number.toString().padStart(2, '0');
                        if (isFixed) badge.innerHTML += ' <i class="fas fa-thumbtack fa-xs"></i>';
                        selectedNumbersList.appendChild(badge);
                    });
                }

                if (config.hasTrevos && selectedTrevos.length > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'badge bg-success me-1 mb-1 fs-6';
                    badge.innerHTML = `<i class="fas fa-clover"></i> ${selectedTrevos.join(', ')}`;
                    selectedNumbersList.appendChild(badge);
                }

                const countBadge = document.createElement('span');
                countBadge.className = 'badge bg-dark ms-2';
                countBadge.textContent = `${currentSelections.length} número(s)`;
                selectedNumbersList.appendChild(countBadge);
            }

            function displayResults(combinations, totalCostValue, config, fixedNumbers, specialSelections) {
                document.getElementById('totalCombinations').textContent = `Total de Apostas: ${combinations.length}`;
                document.getElementById('totalCost').textContent = `Custo Total: ${totalCostValue.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}`;
                
                const combinationsTable = document.getElementById('combinationsTable');
                combinationsTable.innerHTML = '';

                combinations.forEach((combo, index) => {
                    const row = document.createElement('tr');
                    let numbersHtml = combo.map(num => `<span class="badge ${fixedNumbers.includes(num) ? 'bg-success' : 'bg-light text-dark'} me-1 mb-1">${num.toString().padStart(2, '0')}</span>`).join(' ');
                    
                    if (config.hasTeam) numbersHtml += ` <span class="badge bg-info">${specialSelections.team}</span>`;
                    if (config.hasMonth) numbersHtml += ` <span class="badge bg-info">${specialSelections.month}</span>`;
                    if (config.hasTrevos) numbersHtml += ` <span class="badge bg-success"><i class="fas fa-clover"></i> ${specialSelections.trevos.join(', ')}</span>`;

                    row.innerHTML = `
                        <td>${index + 1}<span class="prize-check-icon ms-1"></span></td>
                        <td>${numbersHtml}</td>
                    `;
                    combinationsTable.appendChild(row);
                });

                document.getElementById('resultsSection').classList.remove('d-none');
                document.getElementById('checkHistoryBtnContainer').classList.remove('d-none');
                document.getElementById('resultCheckerSection').classList.remove('d-none');
                document.getElementById('prizeSummary').classList.add('d-none');
                document.getElementById('drawnNumbersInput').value = '';
                if(document.getElementById('drawnTrevosInput')) document.getElementById('drawnTrevosInput').value = '';
                if(document.getElementById('drawnMonthInput')) document.getElementById('drawnMonthInput').value = '';
                if(document.getElementById('drawnTeamInput')) document.getElementById('drawnTeamInput').value = '';
                document.getElementById('resultsSection').scrollIntoView({ behavior: 'smooth' });
            }

            function displayPrizeSummary(prizeCounts, totalPrizeMoney, totalCostValue, config) {
                const prizeList = document.getElementById('prizeList');
                const financialSummaryList = document.getElementById('financialSummaryList');
                prizeList.innerHTML = '';
                let hasPrizes = false;
                
                Object.keys(prizeCounts).sort().reverse().forEach(tier => {
                    const count = prizeCounts[tier];
                    if (count > 0) {
                        hasPrizes = true;
                        const li = document.createElement('li');
                        li.className = 'list-group-item d-flex justify-content-between align-items-center';
                        let tierText = tier;
                        if (config.hasTrevos) tierText = `${tier.replace('+', ' acertos + ')} trevo(s)`;
                        else if (tier === 'month') tierText = 'Mês da Sorte';
                        else if (tier === 'team') tierText = 'Time do Coração';
                        else tierText = `${tier} acertos`;
                        
                        li.innerHTML = `${tierText} <span class="badge bg-primary rounded-pill">${count}</span>`;
                        prizeList.appendChild(li);
                    }
                });

                if (!hasPrizes) {
                    const li = document.createElement('li');
                    li.className = 'list-group-item';
                    li.textContent = 'Nenhuma aposta premiada encontrada.';
                    prizeList.appendChild(li);
                }
                
                financialSummaryList.innerHTML = '';
                const netResult = totalPrizeMoney - totalCostValue;
                const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                financialSummaryList.innerHTML = `
                    <li class="list-group-item d-flex justify-content-between align-items-center">Total Gasto<span>${formatCurrency(totalCostValue)}</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center">Total em Prêmios<span>${formatCurrency(totalPrizeMoney)}</span></li>
                    <li class="list-group-item d-flex justify-content-between align-items-center fw-bold ${netResult >= 0 ? 'text-success' : 'text-danger'}">Saldo Final<span>${formatCurrency(netResult)}</span></li>
                `;
                document.getElementById('prizeSummary').classList.remove('d-none');
            }

            function displayAnalysisResults(frequency, pairs, count, suggestions, config) {
                const container = document.getElementById('analysisResultsContainer');
                let html = `<h4>Análise dos Últimos ${count} Concursos Válidos</h4>`;
                
                html += `<div class="row mt-4">
                            <div class="col-md-6">
                                <h5><i class="fas fa-sort-numeric-down me-2"></i>Dezenas Mais Sorteadas</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead><tr><th>Dezena</th><th>Frequência</th></tr></thead>
                                        <tbody>`;
                frequency.slice(0, 15).forEach(([num, freq]) => {
                    html += `<tr><td><span class="badge bg-secondary">${num.toString().padStart(2,'0')}</span></td><td>${freq}</td></tr>`;
                });
                html += `</tbody></table></div></div>`;

                html += `<div class="col-md-6 mt-4 mt-md-0">
                                <h5><i class="fas fa-link me-2"></i>Pares Mais Sorteados</h5>
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead><tr><th>Par</th><th>Frequência</th></tr></thead>
                                        <tbody>`;
                pairs.slice(0, 15).forEach(([pair, freq]) => {
                    html += `<tr><td><span class="badge bg-secondary">${pair}</span></td><td>${freq}</td></tr>`;
                });
                html += `</tbody></table></div></div>`;

                if (suggestions) {
                    const formatSuggestion = (numbers) => numbers.map(n => `<span class="badge bg-light text-dark">${n.toString().padStart(2, '0')}</span>`).join('');
                    
                    html += `<div class="mt-4">
                                <h5><i class="fas fa-lightbulb me-2"></i>Sugestões para Próximos Jogos</h5>
                                <div class="card bg-dark">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="card-title mb-0"><span class="badge bg-danger me-2">Quentes</span> Jogo com as dezenas mais sorteadas</h6>
                                            <button class="btn btn-sm btn-outline-light use-suggestion-btn" data-suggestion="${suggestions.hot.join(',')}"><i class="fas fa-arrow-circle-left me-1"></i> Usar Jogo</button>
                                        </div>
                                        <div class="suggestion-numbers">${formatSuggestion(suggestions.hot)}</div>
                                        <hr>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="card-title mb-0"><span class="badge bg-primary me-2">Frios</span> Jogo com as dezenas menos sorteadas</h6>
                                            <button class="btn btn-sm btn-outline-light use-suggestion-btn" data-suggestion="${suggestions.cold.join(',')}"><i class="fas fa-arrow-circle-left me-1"></i> Usar Jogo</button>
                                        </div>
                                        <div class="suggestion-numbers">${formatSuggestion(suggestions.cold)}</div>
                                        <hr>
                                        <div class="d-flex justify-content-between align-items-center">
                                            <h6 class="card-title mb-0"><span class="badge bg-warning text-dark me-2">Misto</span> Jogo com dezenas quentes e frias</h6>
                                            <button class="btn btn-sm btn-outline-light use-suggestion-btn" data-suggestion="${suggestions.mixed.join(',')}"><i class="fas fa-arrow-circle-left me-1"></i> Usar Jogo</button>
                                        </div>
                                        <div class="suggestion-numbers">${formatSuggestion(suggestions.mixed)}</div>
                                    </div>
                                </div>
                               </div>`;
                }

                container.innerHTML = html;
                container.style.display = 'block';
                
                if (suggestions) {
                    document.querySelectorAll('.number-btn').forEach(btn => btn.classList.remove('hot-number', 'cold-number'));
                    suggestions.hot.forEach(num => {
                        const btn = document.querySelector(`.number-btn[data-number="${num}"]`);
                        if (btn) btn.classList.add('hot-number');
                    });
                    suggestions.cold.forEach(num => {
                        const btn = document.querySelector(`.number-btn[data-number="${num}"]`);
                        if (btn) btn.classList.add('cold-number');
                    });
                }
            }

            function showError(message) {
                document.getElementById('errorMessage').textContent = message;
                document.getElementById('errorAlert').classList.remove('d-none');
                document.getElementById('errorAlert').scrollIntoView({ behavior: 'smooth' });
            }

            function hideError() {
                document.getElementById('errorAlert').classList.add('d-none');
            }

            function hideResults() {
                document.getElementById('resultsSection').classList.add('d-none');
                document.getElementById('resultCheckerSection').classList.add('d-none');
                document.getElementById('prizeSummary').classList.add('d-none');
                document.getElementById('checkHistoryBtnContainer').classList.add('d-none');
            }

            function showCopyNotification() {
                const copyNotification = document.getElementById('copyNotification');
                copyNotification.classList.remove('d-none');
                setTimeout(() => {
                    copyNotification.classList.add('d-none');
                }, 2000);
            }

            // --- UTILS ---
            function calculateCombinationsCount(n, k) {
                if (k < 0 || k > n) return 0;
                if (k === 0 || k === n) return 1;
                if (k > n / 2) k = n - k;
                let res = 1;
                for (let i = 1; i <= k; i++) {
                    res = res * (n - i + 1) / i;
                }
                return Math.round(res);
            }

            function getCombinations(sourceArray, comboSize) {
                const result = [];
                const n = sourceArray.length;
                if (comboSize < 0 || comboSize > n) return [];
                const indices = Array.from({ length: comboSize }, (_, i) => i);
                while (true) {
                    result.push(indices.map(i => sourceArray[i]));
                    let i = comboSize - 1;
                    while (i >= 0 && indices[i] === i + n - comboSize) i--;
                    if (i < 0) break;
                    indices[i]++;
                    for (let j = i + 1; j < comboSize; j++) indices[j] = indices[j - 1] + 1;
                }
                return result;
            }

            function getCartesianProduct(arrays) {
                return arrays.reduce((a, b) => a.flatMap(x => b.map(y => [...x, y].sort((c, d) => c - d))), [[]]);
            }

            function hexToRgb(hex) {
                const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
                return result ? [
                    parseInt(result[1], 16),
                    parseInt(result[2], 16),
                    parseInt(result[3], 16)
                ] : [0, 0, 0];
            }

            function copyCombinationsToClipboard(combinations, config, specialSelections) {
                if (combinations.length === 0) {
                    showError('Não há combinações para copiar.');
                    return;
                }

                const textToCopy = combinations.map(combo => {
                    let line = combo.map(n => n.toString().padStart(2, '0')).join(' ');
                    if (config.hasTeam) line += ` | ${specialSelections.team}`;
                    if (config.hasMonth) line += ` | ${specialSelections.month}`;
                    if (config.hasTrevos) line += ` | Trevos: ${specialSelections.trevos.join(', ')}`;
                    return line;
                }).join('\n');

                const textArea = document.createElement('textarea');
                textArea.value = textToCopy;
                document.body.appendChild(textArea);
                textArea.select();
                try {
                    document.execCommand('copy');
                    showCopyNotification();
                } catch (err) {
                    showError('Falha ao copiar os jogos. Tente novamente.');
                    console.error('Copy failed:', err);
                }
                document.body.removeChild(textArea);
            }

            function exportData(format, combinations, config, specialSelections, hitResults, drawnNumbersStr, drawnTrevosStr) {
                if (combinations.length === 0) {
                    showError('Não há combinações para exportar.');
                    return;
                }
                const fileName = `${config.displayName.toLowerCase().replace(/[\s-]+/g, '_')}_apostas`;
                if (format === 'pdf') {
                    exportToStyledPdf(fileName, config, combinations, specialSelections);
                } else if (format === 'png') {
                    exportToPng(fileName, config, combinations, hitResults, drawnNumbersStr, specialSelections, drawnTrevosStr);
                } else {
                    let content = '';
                    let mimeType = '';
                    if (format === 'csv') {
                        let headers = config.isColumnar ?
                            Array.from({ length: 7 }, (_, i) => `Coluna ${i + 1}`).join(',') :
                            Array.from({ length: config.betSize }, (_, i) => `N${i + 1}`).join(',');
                        if (config.hasTeam) headers += ',Time do Coração';
                        if (config.hasMonth) headers += ',Mês da Sorte';
                        if (config.hasTrevos) headers += ',Trevos';
                        
                        content = 'Aposta,' + headers + '\n';
                        combinations.forEach((combo, index) => {
                            content += `${index + 1},${combo.join(',')}`;
                            if (config.hasTeam) content += `,${specialSelections.team}`;
                            if (config.hasMonth) content += `,${specialSelections.month}`;
                            if (config.hasTrevos) content += `,${specialSelections.trevos.join(' ')}`;
                            content += '\n';
                        });
                        mimeType = 'text/csv';
                    } else { // txt
                        combinations.forEach((combo, index) => {
                            content += `Aposta ${String(index + 1).padStart(4, '0')}: ${combo.map(n => n.toString().padStart(2, '0')).join(' ')}`;
                            if (config.hasTeam) content += ` | Time: ${specialSelections.team}`;
                            if (config.hasMonth) content += ` | Mês: ${specialSelections.month}`;
                            if (config.hasTrevos) content += ` | Trevos: ${specialSelections.trevos.join(', ')}`;
                            content += '\n';
                        });
                        mimeType = 'text/plain';
                    }
                    const blob = new Blob([content], { type: `${mimeType};charset=utf-8;` });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${fileName}.${format}`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }
            }

            function exportToPng(fileName, config, combinations, hitResults, drawnNumbersStr, specialSelections, drawnTrevosStr) {
                const exportContainer = document.createElement('div');
                exportContainer.id = 'png-export-container';
                exportContainer.style.position = 'absolute';
                exportContainer.style.left = '-9999px';
                exportContainer.style.backgroundColor = 'white';
                exportContainer.style.padding = '20px';
                exportContainer.style.width = '800px';
                exportContainer.style.fontFamily = 'Arial, sans-serif';
                
                const hasCheckedResults = hitResults && hitResults.length > 0;
                let headerText = `Total de ${combinations.length} combinações`;
                if(hasCheckedResults && drawnNumbersStr) {
                    let fullDrawnStr = drawnNumbersStr;
                    if (config.hasTrevos && drawnTrevosStr) {
                        fullDrawnStr += ` | Trevos: ${drawnTrevosStr}`;
                    }
                    headerText += `<br><small style="font-size: 12px; color: #666;">Conferido com: ${fullDrawnStr}</small>`;
                }

                let content = `<div style="text-align: center; border-bottom: 2px solid ${config.color}; padding-bottom: 10px; margin-bottom: 15px;"><h1 style="color: ${config.color}; margin: 0;">Apostas - ${config.displayName}</h1><p style="margin: 0; color: #555;">${headerText}</p></div><div style="column-count: 3; column-gap: 20px;">`;
                
                combinations.forEach((combo, index) => {
                    let trophyIcon = '';
                    if (hasCheckedResults) {
                        const hitInfo = hitResults[index];
                        if (hitInfo) {
                            const tier = config.hasTrevos ? `${hitInfo.hits}+${hitInfo.trevoHits}` : hitInfo.hits;
                            const tierIndex = config.prizeTiers.indexOf(tier);
                            if(tierIndex !== -1) {
                                if (tierIndex === 0) trophyIcon = '🏆 '; // Maior prêmio
                                else if (tierIndex < config.prizeTiers.length - 1) trophyIcon = '🥈 '; // Intermediário
                                else trophyIcon = '🥉 '; // Menor prêmio
                            }
                        }
                    }

                    let comboText = combo.map(n => n.toString().padStart(2, '0')).join(' ');
                    if (config.hasTeam) comboText += ` | ${specialSelections.team}`;
                    if (config.hasMonth) comboText += ` | ${specialSelections.month}`;
                    if (config.hasTrevos) comboText += ` | Trevos: ${specialSelections.trevos.join(', ')}`;

                    content += `<p style="margin: 0 0 8px 0; font-size: 14px; color: #333; break-inside: avoid-column;">${trophyIcon}<strong style="color: ${config.color};">${String(index + 1).padStart(3, '0')}:</strong> ${comboText}</p>`;
                });
                content += `</div>`;
                exportContainer.innerHTML = content;
                document.body.appendChild(exportContainer);
                html2canvas(exportContainer, { scale: 2 }).then(canvas => {
                    const link = document.createElement('a');
                    link.download = `${fileName}.png`;
                    link.href = canvas.toDataURL('image/png');
                    link.click();
                    document.body.removeChild(exportContainer);
                }).catch(err => {
                    showError("Ocorreu um erro ao gerar a imagem PNG.");
                    console.error("html2canvas error:", err);
                    document.body.removeChild(exportContainer);
                });
            }

            function exportToStyledPdf(fileName, config, combinations, specialSelections) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF('p', 'mm', 'a4');
                const pageW = doc.internal.pageSize.getWidth();
                const pageH = doc.internal.pageSize.getHeight();
                const margin = 10;
                const cardGap = 8;
                const cardsPerRow = 2;

                const cardW = (pageW - (margin * 2) - (cardGap * (cardsPerRow - 1))) / cardsPerRow;
                
                const headerH = 10;
                const gridPadding = 2;
                const cellMargin = 0.5;
                const footerH = 5; // Espaço para texto de seleções especiais
                let gridH;

                if (config.isColumnar) {
                    const numCols = 7;
                    const cellW = (cardW - (gridPadding * 2)) / numCols - cellMargin;
                    const cellH = cellW * 0.9;
                    gridH = 10 * (cellH + cellMargin);
                } else {
                    const numRowsInGrid = Math.ceil(config.totalNumbers / config.pdfGridCols);
                    const cellW = (cardW - (gridPadding * 2)) / config.pdfGridCols - cellMargin;
                    const cellH = cellW;
                    gridH = numRowsInGrid * (cellH + cellMargin);
                }
                const cardH = headerH + gridH + (gridPadding * 2) + footerH;

                const cardsPerCol = Math.floor((pageH - (margin * 2) + cardGap) / (cardH + cardGap));
                const cardsPerPage = cardsPerRow * cardsPerCol;

                if (cardsPerPage <= 0) {
                    showError("Os volantes são muito grandes para caber em uma página.");
                    return;
                }

                combinations.forEach((combo, index) => {
                    if (index > 0 && index % cardsPerPage === 0) {
                        doc.addPage();
                    }
                    const indexOnPage = index % cardsPerPage;
                    const col = indexOnPage % cardsPerRow;
                    const row = Math.floor(indexOnPage / cardsPerRow);
                    const x = margin + col * (cardW + cardGap);
                    const y = margin + row * (cardH + cardGap);
                    drawBetCard(doc, combo, index + 1, x, y, cardW, cardH, config, specialSelections);
                });
                doc.save(`${fileName}.pdf`);
            }

            function drawBetCard(doc, combo, betNumber, x, y, w, h, config, specialSelections) {
                const headerH = 10;
                const padding = 2;

                doc.setDrawColor(220);
                doc.setFillColor(255, 255, 255);
                doc.roundedRect(x, y, w, h, 2, 2, 'FD');

                const [r, g, b] = hexToRgb(config.color);
                doc.setFillColor(r, g, b);
                doc.roundedRect(x, y, w, headerH, 2, 2, 'F');
                doc.setTextColor(255, 255, 255);
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(config.displayName, x + padding + 2, y + headerH / 2 + 2);
                doc.setFontSize(9);
                doc.text(`Aposta #${betNumber}`, x + w - padding - 2, y + headerH / 2 + 2, { align: 'right' });

                const gridX = x + padding;
                const gridY = y + headerH + padding + 2;
                const gridW = w - (padding * 2);
                const cellMargin = 0.5;

                if (config.isColumnar) {
                    const numCols = 7;
                    const cellW = (gridW / numCols) - cellMargin;
                    const cellH = cellW * 0.9;
                    const fontSize = cellW * 0.5;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(fontSize);

                    for (let c = 0; c < numCols; c++) {
                        const colX = gridX + c * (cellW + cellMargin);
                        for (let num = 0; num < 10; num++) {
                            const cellY = gridY + num * (cellH + cellMargin);
                            const numStr = num.toString();
                            if (combo[c] === num) {
                                doc.setFillColor(40, 40, 40);
                                doc.roundedRect(colX, cellY, cellW, cellH, 1, 1, 'F');
                                doc.setTextColor(255, 255, 255);
                                doc.text(numStr, colX + cellW / 2, cellY + cellH / 2, { align: 'center', baseline: 'middle' });
                            } else {
                                doc.setDrawColor(230);
                                doc.roundedRect(colX, cellY, cellW, cellH, 1, 1, 'D');
                                doc.setTextColor(150, 150, 150);
                                doc.text(numStr, colX + cellW / 2, cellY + cellH / 2, { align: 'center', baseline: 'middle' });
                            }
                        }
                    }
                } else {
                    const cellW = (gridW / config.pdfGridCols) - cellMargin;
                    const cellH = cellW;
                    const fontSize = cellW * 0.45;
                    doc.setFont('helvetica', 'bold');
                    doc.setFontSize(fontSize);

                    for (let i = 1; i <= config.totalNumbers; i++) {
                        const r_grid = Math.floor((i - 1) / config.pdfGridCols);
                        const c_grid = (i - 1) % config.pdfGridCols;
                        const cellX = gridX + c_grid * (cellW + cellMargin);
                        const cellY = gridY + r_grid * (cellH + cellMargin);
                        const numStr = i.toString().padStart(2, '0');

                        if (combo.includes(i)) {
                            doc.setFillColor(40, 40, 40);
                            doc.roundedRect(cellX, cellY, cellW, cellH, 1, 1, 'F');
                            doc.setTextColor(255, 255, 255);
                            doc.text(numStr, cellX + cellW / 2, cellY + cellH / 2, { align: 'center', baseline: 'middle' });
                        } else {
                            doc.setDrawColor(230);
                            doc.roundedRect(cellX, cellY, cellW, cellH, 1, 1, 'D');
                            doc.setTextColor(150, 150, 150);
                            doc.text(numStr, cellX + cellW / 2, cellY + cellH / 2, { align: 'center', baseline: 'middle' });
                        }
                    }
                }
                
                // Adiciona informações especiais no rodapé do volante
                let specialY = y + h - padding - 1;
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(8);
                doc.setTextColor(80, 80, 80);

                let specialText = '';
                if (config.hasTeam && specialSelections.team) {
                    specialText += `Time: ${specialSelections.team}`;
                }
                if (config.hasMonth && specialSelections.month) {
                    specialText += `${specialText ? ' | ' : ''}Mês: ${specialSelections.month}`;
                }
                if (config.hasTrevos && specialSelections.trevos.length > 0) {
                    specialText += `${specialText ? ' | ' : ''}Trevos: ${specialSelections.trevos.join(', ')}`;
                }

                if (specialText) {
                    doc.text(specialText, x + padding + 2, specialY);
                }

                doc.setTextColor(0, 0, 0);
            }

            // --- MAIN LOGIC ---
            // --- DOM ELEMENTS ---
            const gameModeSelect = document.getElementById('gameModeSelect');
            const numberGridContainer = document.getElementById('numberGridContainer');
            const superSeteGridContainer = document.getElementById('superSeteGridContainer');
            const clearBtn = document.getElementById('clearBtn');
            const generateBtn = document.getElementById('generateBtn');
            const loadingSpinner = document.getElementById('loadingSpinner');
            const exportCsv = document.getElementById('exportCsv');
            const exportTxt = document.getElementById('exportTxt');
            const exportPdf = document.getElementById('exportPdf');
            const exportPng = document.getElementById('exportPng');
            const copyGamesBtn = document.getElementById('copyGamesBtn');
            const gameNameHeaders = document.querySelectorAll('.gameNameHeader');
            const rulesAlert = document.getElementById('rulesAlert');
            const selectionHeader = document.getElementById('selectionHeader');
            const checkResultsBtn = document.getElementById('checkResultsBtn');
            const generationModeContainer = document.getElementById('generationModeContainer');
            const generationModeRadios = document.querySelectorAll('input[name="generationMode"]');
            const fixedNumbersInfo = document.getElementById('fixedNumbersInfo');
            const specialSelectionContainer = document.getElementById('specialSelectionContainer');
            const contestNumberInput = document.getElementById('contestNumberInput');
            const fetchLatestContestBtn = document.getElementById('fetchLatestContestBtn');
            const analyzeContestBtn = document.getElementById('analyzeContestBtn');
            const historyAnalysisResult = document.getElementById('historyAnalysisResult');
            const runAnalysisBtn = document.getElementById('runAnalysisBtn');
            const contestCountInput = document.getElementById('contestCountInput');
            const analysisResultsContainer = document.getElementById('analysisResultsContainer');
            const analysisLoadingSpinner = document.getElementById('analysisLoadingSpinner');
            const selectAllBtn = document.getElementById('selectAllBtn');
            const resetAllBtn = document.getElementById('resetAllBtn');
            const analyzeRangeBtn = document.getElementById('analyzeRangeBtn');
            const rangeHistoryAnalysisResult = document.getElementById('rangeHistoryAnalysisResult');
            const upcomingTab = document.getElementById('upcoming-tab');


            // --- STATE ---
            let state = {
                selectedNumbers: [],
                fixedNumbers: [],
                selectedTrevos: [],
                superSeteSelections: [[],[],[],[],[],[],[]],
                generatedCombinations: [],
                currentGameMode: 'lotofacil',
                totalCostValue: 0,
                hitResults: [],
                winningCombinationsInRange: [], // New state for range analysis
                selectedTeam: null,
                selectedMonth: null,
            };

            // --- INITIALIZATION ---
            function initializeApp() {
                gameModeSelect.addEventListener('change', (e) => updateUIForGameMode(e.target.value));
                clearBtn.addEventListener('click', clearSelection);
                generateBtn.addEventListener('click', handleGenerateClick);
                checkResultsBtn.addEventListener('click', handleCheckResults);
                
                // CORREÇÃO: Argumentos passados corretamente para as funções de exportação
                exportCsv.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    exportData('csv', state.generatedCombinations, lotteryConfigs[state.currentGameMode], getSpecialSelections(), state.hitResults, document.getElementById('drawnNumbersInput').value.trim()); 
                });
                exportTxt.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    exportData('txt', state.generatedCombinations, lotteryConfigs[state.currentGameMode], getSpecialSelections()); 
                });
                exportPdf.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    exportData('pdf', state.generatedCombinations, lotteryConfigs[state.currentGameMode], getSpecialSelections()); 
                });
                exportPng.addEventListener('click', (e) => { 
                    e.preventDefault(); 
                    const drawnTrevosStr = document.getElementById('drawnTrevosInput')?.value.trim() || '';
                    exportData('png', state.generatedCombinations, lotteryConfigs[state.currentGameMode], getSpecialSelections(), state.hitResults, document.getElementById('drawnNumbersInput').value.trim(), drawnTrevosStr); 
                });

                copyGamesBtn.addEventListener('click', () => copyCombinationsToClipboard(state.generatedCombinations, lotteryConfigs[state.currentGameMode], getSpecialSelections()));
                generationModeRadios.forEach(radio => radio.addEventListener('change', (e) => {
                    fixedNumbersInfo.classList.toggle('d-none', e.target.value !== 'fixo');
                }));
                fetchLatestContestBtn.addEventListener('click', handleFetchLatestContest);
                analyzeContestBtn.addEventListener('click', handleAnalyzeContest);
                analyzeRangeBtn.addEventListener('click', handleAnalyzeContestRange);
                runAnalysisBtn.addEventListener('click', runAnalysis);
                analysisResultsContainer.addEventListener('click', handleUseSuggestionClick);
                selectAllBtn.addEventListener('click', handleSelectAll);
                resetAllBtn.addEventListener('click', handleResetAll);

                let upcomingDataLoaded = false;
                upcomingTab.addEventListener('show.bs.tab', function (event) {
                    if (!upcomingDataLoaded) {
                        fetchUpcomingContests();
                        upcomingDataLoaded = true;
                    }
                });

                updateUIForGameMode(state.currentGameMode);
                restoreState();
            }
            
            function updateUIForGameMode(mode) {
                state.currentGameMode = mode;
                const config = lotteryConfigs[mode];
                
                applyThemeColor(config.color, config.hoverColor);
                gameNameHeaders.forEach(h => h.textContent = config.displayName);
                rulesAlert.innerHTML = `<i class="fas fa-info-circle me-2"></i>Selecione ${config.isColumnar ? 'de 1 a 3 números por coluna' : `entre <strong>${config.minSelection}</strong> e <strong>${config.maxSelection}</strong> números`} para gerar as apostas.`;
                selectionHeader.innerHTML = `<i class="fas fa-th me-2"></i>Selecione seus números`;
                document.getElementById('drawnNumbersInput').placeholder = `Ex: ${Array.from({length: config.betSize}, (_, i) => i + 1).join(', ')}`;

                numberGridContainer.classList.toggle('d-none', !!config.isColumnar);
                superSeteGridContainer.classList.toggle('d-none', !config.isColumnar);
                generationModeContainer.classList.toggle('d-none', !!config.isColumnar || ['lotomania', 'timemania'].includes(mode));
                
                if (config.isColumnar) {
                    initializeSuperSeteGrid(superSeteGridContainer, handleSuperSeteClick);
                } else {
                    initializeNumberGrid(config.totalNumbers, numberGridContainer, handleNumberClick);
                }

                buildSpecialSelectors(config, specialSelectionContainer, handleTrevoClick);
                buildSpecialCheckers(config, document.getElementById('specialCheckerContainer'));
                clearSelection();
                analysisResultsContainer.style.display = 'none';
                
                document.querySelectorAll('.number-btn').forEach(btn => {
                    btn.classList.remove('hot-number', 'cold-number');
                });
            }

            // --- EVENT HANDLERS ---
            function handleNumberClick(e) {
                const button = e.currentTarget;
                const number = parseInt(button.dataset.number);
                const config = lotteryConfigs[state.currentGameMode];
                const isSelected = state.selectedNumbers.includes(number);
                const isFixed = state.fixedNumbers.includes(number);
                const generationMode = document.querySelector('input[name="generationMode"]:checked').value;

                if (!isSelected) {    
                    if (state.selectedNumbers.length < config.maxSelection) {
                        state.selectedNumbers.push(number);
                        button.classList.add('active');
                    } else {
                        showError(`Você só pode selecionar até ${config.maxSelection} números para a ${config.displayName}.`);
                    }
                } else if (isSelected && !isFixed && generationMode === 'fixo') {
                    if (state.fixedNumbers.length < (config.betSize -1) ) {
                        state.fixedNumbers.push(number);
                        button.classList.add('btn-fixed');
                        button.innerHTML = `<span>${number.toString().padStart(2, '0')}</span><i class="fas fa-thumbtack"></i>`;
                    } else {
                        showError(`Você só pode fixar até ${config.betSize - 1} dezenas.`);
                    }
                } else {
                    state.selectedNumbers = state.selectedNumbers.filter(n => n !== number);
                    state.fixedNumbers = state.fixedNumbers.filter(n => n !== number);
                    button.classList.remove('active', 'btn-fixed');
                    button.querySelector('.fa-thumbtack')?.remove();
                }
                
                state.selectedNumbers.sort((a, b) => a - b);
                state.fixedNumbers.sort((a, b) => a - b);
                updateSelectedNumbersDisplay(state.selectedNumbers, state.fixedNumbers, state.superSeteSelections, state.selectedTrevos, config);
                saveState();
            }

            function handleSuperSeteClick(e) {
                const btn = e.currentTarget;
                const number = parseInt(btn.dataset.number);
                const column = parseInt(btn.dataset.column);
                
                const colSelections = state.superSeteSelections[column];
                const isSelected = colSelections.includes(number);

                if (isSelected) {
                    state.superSeteSelections[column] = colSelections.filter(n => n !== number);
                    btn.classList.remove('active');
                } else {
                    if (colSelections.length < 3) {
                        state.superSeteSelections[column].push(number);
                        btn.classList.add('active');
                    } else {
                        showError(`Você só pode selecionar até 3 números por coluna.`);
                    }
                }
                updateSelectedNumbersDisplay(state.selectedNumbers, state.fixedNumbers, state.superSeteSelections, state.selectedTrevos, lotteryConfigs[state.currentGameMode]);
                saveState();
            }

            function handleTrevoClick(e) {
                const btn = e.currentTarget;
                const trevo = parseInt(btn.dataset.trevo);
                if (state.selectedTrevos.includes(trevo)) {
                    state.selectedTrevos = state.selectedTrevos.filter(t => t !== trevo);
                    btn.classList.remove('active');
                } else {
                    if (state.selectedTrevos.length < 2) {
                        state.selectedTrevos.push(trevo);
                        btn.classList.add('active');
                    } else {
                        showError("Você só pode selecionar 2 trevos.");
                    }
                }
                updateSelectedNumbersDisplay(state.selectedNumbers, state.fixedNumbers, state.superSeteSelections, state.selectedTrevos, lotteryConfigs[state.currentGameMode]);
                saveState();
            }

            function handleGenerateClick() {
                hideError();
                const config = lotteryConfigs[state.currentGameMode];
                let combinations = [];

                if (config.isColumnar) {
                    let totalSelections = 0;
                    let combinationsCount = 1;
                    for(let i=0; i<7; i++) {
                        if (state.superSeteSelections[i].length === 0) {
                            showError(`Você precisa selecionar pelo menos um número na coluna ${i + 1}.`);
                            return;
                        }
                        totalSelections += state.superSeteSelections[i].length;
                        combinationsCount *= state.superSeteSelections[i].length;
                    }
                    if (totalSelections < config.minSelection) {
                        showError(`Você precisa selecionar um total de pelo menos ${config.minSelection} números.`);
                        return;
                    }
                    if (combinationsCount > MAX_COMBINATIONS) {
                        showError(`Sua seleção irá gerar ${combinationsCount.toLocaleString('pt-BR')} combinações. O limite é ${MAX_COMBINATIONS.toLocaleString('pt-BR')}.`);
                        return;
                    }
                    combinations = getCartesianProduct(state.superSeteSelections.filter(c => c.length > 0));

                } else {
                    const mode = document.querySelector('input[name="generationMode"]:checked').value;
                    let numbersToCombineFrom, numbersToChoose;

                    if (mode === 'fixo') {
                        if (state.fixedNumbers.length === 0 || state.fixedNumbers.length >= config.betSize) {
                            showError(`Para o modo fixo, selecione de 1 a ${config.betSize - 1} dezenas fixas.`);
                            return;
                        }
                        numbersToCombineFrom = state.selectedNumbers.filter(n => !state.fixedNumbers.includes(n));
                        numbersToChoose = config.betSize - state.fixedNumbers.length;
                        if (numbersToCombineFrom.length < numbersToChoose) {
                            showError(`Você precisa selecionar mais ${numbersToChoose - numbersToCombineFrom.length} número(s) (além dos fixos).`);
                            return;
                        }
                    } else {
                        if (state.selectedNumbers.length < config.minSelection) {
                            showError(`Selecione pelo menos ${config.minSelection} números.`);
                            return;
                        }
                        numbersToCombineFrom = state.selectedNumbers;
                        numbersToChoose = config.betSize;
                    }

                    if (config.hasTrevos && state.selectedTrevos.length !== 2) {
                        showError("Você precisa selecionar exatamente 2 trevos da sorte.");
                        return;
                    }

                    const combinationsCount = calculateCombinationsCount(numbersToCombineFrom.length, numbersToChoose);
                    if (combinationsCount > MAX_COMBINATIONS) {
                        showError(`Sua seleção irá gerar ${combinationsCount.toLocaleString('pt-BR')} combinações. O limite é ${MAX_COMBINATIONS.toLocaleString('pt-BR')}. Reduza a quantidade de números.`);
                        return;
                    }
                    
                    const smallerCombos = getCombinations(numbersToCombineFrom, numbersToChoose);
                    combinations = (mode === 'fixo')
                        ? smallerCombos.map(combo => [...state.fixedNumbers, ...combo].sort((a,b)=>a-b))
                        : smallerCombos;
                }

                if (combinations.length === 0) {
                    showError("Nenhuma combinação pôde ser gerada com os números e o modo selecionado.");
                    return;
                }

                state.generatedCombinations = combinations;
                state.totalCostValue = combinations.length * config.cost;

                loadingSpinner.classList.remove('d-none');
                setTimeout(() => {
                    displayResults(state.generatedCombinations, state.totalCostValue, config, state.fixedNumbers, getSpecialSelections());
                    loadingSpinner.classList.add('d-none');
                    saveState();
                }, 50);
            }

            async function handleFetchLatestContest() {
                const spinner = fetchLatestContestBtn.querySelector('.spinner-border');
                spinner.classList.remove('d-none');
                historyAnalysisResult.classList.add('d-none');
                const config = lotteryConfigs[state.currentGameMode];
                
                try {
                    const localData = await getLatestContestFromLocalDB(config.apiName);
                    if (localData && localData.numero) {
                        contestNumberInput.value = localData.numero;
                        console.log("Último concurso encontrado no db.json.");
                    } else {
                        console.warn("Não foi encontrado no db.json, tentando API da Caixa.");
                        const data = await fetchApiData(`https://servicebus2.caixa.gov.br/portaldeloterias/api/${config.apiName}`);
                        if (data && data.numero) {
                            contestNumberInput.value = data.numero;
                        } else {
                            throw new Error("Formato de resposta da API inesperado.");
                        }
                    }
                } catch (error) {
                    console.error("Falha ao buscar o último concurso (local e API):", error);
                    historyAnalysisResult.innerHTML = `<div class="alert alert-danger">Falha ao buscar dados. Tente inserir o número do concurso manualmente.</div>`;
                    historyAnalysisResult.classList.remove('d-none');
                } finally {
                    spinner.classList.add('d-none');
                }
            }

            async function handleAnalyzeContest() {
                const contestNumber = contestNumberInput.value;
                if (!contestNumber) {
                    historyAnalysisResult.innerHTML = `<div class="alert alert-danger">Por favor, insira um número de concurso.</div>`;
                    historyAnalysisResult.classList.remove('d-none');
                    return;
                }
                historyAnalysisResult.innerHTML = `<div class="text-center"><div class="spinner-border spinner-border-sm" role="status"></div> Buscando resultado...</div>`;
                historyAnalysisResult.classList.remove('d-none');
                
                const config = lotteryConfigs[state.currentGameMode];
                let data = null;

                data = await searchLocalDatabase(config.apiName, contestNumber);

                if (data) {
                    console.log(`Concurso ${contestNumber} encontrado no db.json.`);
                    processAndDisplayHistory(data, config);
                } else {
                    console.warn(`Concurso ${contestNumber} não encontrado no db.json, tentando API da Caixa.`);
                    try {
                        data = await fetchApiData(`https://servicebus2.caixa.gov.br/portaldeloterias/api/${config.apiName}/${contestNumber}`);
                        if (data.numero === 0 || data.error) throw new Error("Concurso não encontrado na API.");
                        processAndDisplayHistory(data, config);
                    } catch (error) {
                        console.error(`Falha ao buscar dados do concurso ${contestNumber} (local e API):`, error);
                        const fallbackUrl = `https://confiraloterias.com.br/resultados-da-${config.fallbackSlug}/concurso-${contestNumber}`;
                        historyAnalysisResult.innerHTML = `<div class="alert alert-danger">
                            Falha ao buscar dados do concurso ${contestNumber}.
                            <br>
                            Verifique o número e tente novamente, ou consulte manualmente em: 
                            <a href="${fallbackUrl}" target="_blank" rel="noopener noreferrer">Confira Loterias</a>
                        </div>`;
                    }
                }
            }
            
            function processAndDisplayHistory(data, config) {
                const drawnNumbers = data.listaDezenas.map(n => parseInt(n));
                const drawnTrevos = data.listaTrevosSorteados ? data.listaTrevosSorteados.map(t => parseInt(t)) : [];
                const drawnMonth = data.mesSorte || null;
                const drawnTeam = data.nomeTimeCoracao || data.nomeTimeCoracaoMesSorte || null;

                const analysis = checkPrizes(drawnNumbers, config, drawnTrevos, drawnMonth, drawnTeam);

                let resultHtml = `<h5>Análise do Concurso ${data.numero} (${data.dataApuracao})</h5>`;
                resultHtml += `<p><strong>Números Sorteados:</strong> ${drawnNumbers.join(', ')}`;
                if (config.hasTrevos && drawnTrevos.length > 0) resultHtml += ` | <strong>Trevos:</strong> ${drawnTrevos.join(', ')}`;
                if (config.hasMonth && drawnMonth) resultHtml += ` | <strong>Mês:</strong> ${drawnMonth}`;
                if (config.hasTeam && drawnTeam) resultHtml += ` | <strong>Time:</strong> ${drawnTeam}`;
                resultHtml += `</p>`;
                
                resultHtml += '<div class="row"><div class="col-md-6">';
                resultHtml += '<h6>Resumo da Premiação</h6><ul class="list-group">';

                let hasPrizes = false;
                Object.keys(analysis.prizeCounts).forEach(tier => {
                    const count = analysis.prizeCounts[tier];
                    if (count > 0) {
                        hasPrizes = true;
                        let tierText = getTierText(tier, config);
                        resultHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">${tierText} <span class="badge bg-primary rounded-pill">${count}</span></li>`;
                    }
                });

                if (!hasPrizes) resultHtml += '<li class="list-group-item">Nenhuma aposta premiada encontrada.</li>';
                
                resultHtml += '</ul></div><div class="col-md-6 mt-3 mt-md-0">';
                resultHtml += '<h6>Análise Financeira</h6><ul class="list-group">';
                const netResult = analysis.totalPrizeMoney - state.totalCostValue;
                const formatCurrency = (value) => value.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });
                resultHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">Total Gasto<span>${formatCurrency(state.totalCostValue)}</span></li>`;
                resultHtml += `<li class="list-group-item d-flex justify-content-between align-items-center">Total em Prêmios<span>${formatCurrency(analysis.totalPrizeMoney)}</span></li>`;
                resultHtml += `<li class="list-group-item d-flex justify-content-between align-items-center fw-bold ${netResult >= 0 ? 'text-success' : 'text-danger'}">Saldo Final<span>${formatCurrency(netResult)}</span></li>`;
                resultHtml += '</ul></div></div>';

                historyAnalysisResult.innerHTML = resultHtml;
            }

            function getTierText(tier, config) {
                if (config.hasTrevos) return `${tier.replace('+', ' acertos + ')} trevo(s)`;
                if (tier === 'month') return 'Mês da Sorte';
                if (tier === 'team') return 'Time do Coração';
                return `${tier} acertos`;
            }

            function handleCheckResults() {
                hideError();
                const config = lotteryConfigs[state.currentGameMode];
                const drawnNumbersInput = document.getElementById('drawnNumbersInput');
                const drawnNumbersStr = drawnNumbersInput.value.trim();

                if (!drawnNumbersStr) {
                    showError("Por favor, insira os números sorteados.");
                    return;
                }
                const drawnNumbers = drawnNumbersStr.split(/[\s,]+/).map(n => parseInt(n)).filter(n => !isNaN(n) && n > 0 && n <= config.totalNumbers);
                
                let expectedSize = config.isColumnar ? 7 : config.betSize;

                if (new Set(drawnNumbers).size !== expectedSize) {
                    showError(`Você deve inserir ${expectedSize} números únicos e válidos para a ${config.displayName}.`);
                    return;
                }

                let drawnTrevos = [], drawnMonth = null, drawnTeam = null;
                if (config.hasTrevos) {
                    const drawnTrevosStr = document.getElementById('drawnTrevosInput').value.trim();
                    if(!drawnTrevosStr) { showError("Por favor, insira os trevos sorteados."); return; }
                    drawnTrevos = drawnTrevosStr.split(/[\s,]+/).map(n => parseInt(n)).filter(n => !isNaN(n) && n > 0 && n <= 6);
                    if (new Set(drawnTrevos).size !== config.trevoSize) { showError(`Você deve inserir ${config.trevoSize} trevos únicos e válidos.`); return; }
                }
                if (config.hasMonth) {
                    drawnMonth = document.getElementById('drawnMonthInput').value.trim();
                    if(!drawnMonth) { showError("Por favor, insira o Mês da Sorte."); return; }
                }
                if (config.hasTeam) {
                    drawnTeam = document.getElementById('drawnTeamInput').value.trim();
                    if(!drawnTeam) { showError("Por favor, insira o Time do Coração."); return; }
                }
                
                const analysis = checkPrizes(drawnNumbers, config, drawnTrevos, drawnMonth, drawnTeam);
                displayPrizeSummary(analysis.prizeCounts, analysis.totalPrizeMoney, state.totalCostValue, config);
                
                const combinationsTable = document.getElementById('combinationsTable');
                document.querySelectorAll('.prize-check-icon').forEach(icon => icon.innerHTML = '');
                state.hitResults.forEach((hitInfo, index) => {
                    const tier = config.hasTrevos ? `${hitInfo.hits}+${hitInfo.trevoHits}` : hitInfo.hits;
                    const tierIndex = config.prizeTiers.indexOf(tier);

                    if(tierIndex !== -1) {
                        let trophyHtml = '';
                        if (tierIndex === 0) trophyHtml = '<i class="fas fa-trophy text-warning" title="Acerto máximo!"></i>';
                        else if (tierIndex < config.prizeTiers.length - 1) trophyHtml = '<i class="fas fa-trophy text-secondary" title="Acerto intermediário"></i>';
                        else trophyHtml = '<i class="fas fa-trophy text-bronze" title="Acerto mínimo"></i>';
                        
                        const row = combinationsTable.rows[index];
                        if(row) {
                            const iconSpan = row.querySelector('.prize-check-icon');
                            if(iconSpan) iconSpan.innerHTML = trophyHtml;
                        }
                    }
                });
            }

            function handleUseSuggestionClick(event) {
                if (!event.target.classList.contains('use-suggestion-btn')) return;

                const numbers = event.target.dataset.suggestion.split(',').map(Number);
                
                const generatorTab = new bootstrap.Tab(document.getElementById('generator-tab'));
                generatorTab.show();

                setTimeout(() => {
                    clearSelection();
                    state.selectedNumbers = numbers;
                    
                    document.querySelectorAll('#numberGridContainer .number-btn').forEach(btn => {
                        const btnNum = parseInt(btn.dataset.number);
                        btn.classList.toggle('active', state.selectedNumbers.includes(btnNum));
                    });

                    updateSelectedNumbersDisplay(state.selectedNumbers, state.fixedNumbers, state.superSeteSelections, state.selectedTrevos, lotteryConfigs[state.currentGameMode]);
                    window.scrollTo({ top: 0, behavior: 'smooth' });
                }, 150);
            }
            
            function handleSelectAll() {
                const config = lotteryConfigs[state.currentGameMode];
                
                if (config.isColumnar) {
                    for (let col = 0; col < 7; col++) {
                        state.superSeteSelections[col] = [0, 1, 2];
                    }
                    document.querySelectorAll('#superSeteGridContainer .number-btn').forEach(btn => {
                        const num = parseInt(btn.dataset.number);
                        const col = parseInt(btn.dataset.column);
                        btn.classList.toggle('active', state.superSeteSelections[col].includes(num));
                    });
                } else {
                    state.selectedNumbers = [];
                    const maxSelect = Math.min(config.maxSelection, config.totalNumbers);
                    for (let i = 1; i <= maxSelect; i++) {
                        state.selectedNumbers.push(i);
                    }
                    document.querySelectorAll('#numberGridContainer .number-btn').forEach(btn => {
                        const num = parseInt(btn.dataset.number);
                        btn.classList.toggle('active', state.selectedNumbers.includes(num));
                    });
                }
                
                updateSelectedNumbersDisplay(state.selectedNumbers, state.fixedNumbers, state.superSeteSelections, state.selectedTrevos, config);
                hideError();
                saveState();
            }
            
            function handleResetAll() {
                // Usando um modal customizado ou uma confirmação mais simples no futuro
                // if (confirm('Tem certeza que deseja limpar tudo? Isso removerá todas as apostas e seleções atuais.')) {
                    localStorage.removeItem('lotteryGeneratorState');
                    clearSelection();
                    hideResults();
                    
                    state.currentGameMode = 'lotofacil';
                    gameModeSelect.value = state.currentGameMode;
                    updateUIForGameMode(state.currentGameMode);
                // }
            }

            // --- CORE LOGIC ---
            function checkPrizes(drawnNumbers, config, drawnTrevos = [], drawnMonth = null, drawnTeam = null) {
                const prizeCounts = {};
                config.prizeTiers.forEach(tier => prizeCounts[tier] = 0);
                if (config.hasMonth) prizeCounts['month'] = 0;
                if (config.hasTeam) prizeCounts['team'] = 0;

                let totalPrizeMoney = 0;
                state.hitResults = [];

                const specialSelections = getSpecialSelections();

                if (config.hasMonth && specialSelections.month?.toLowerCase() === drawnMonth?.toLowerCase()) {
                    prizeCounts['month'] = state.generatedCombinations.length;
                    totalPrizeMoney += (config.prizeValues['month'] || 0) * prizeCounts['month'];
                }
                if (config.hasTeam && specialSelections.team?.toLowerCase() === drawnTeam?.toLowerCase()) {
                    prizeCounts['team'] = state.generatedCombinations.length;
                    totalPrizeMoney += (config.prizeValues['team'] || 0) * prizeCounts['team'];
                }

                state.generatedCombinations.forEach(combo => {
                    let hits = config.isColumnar ? 
                        combo.filter((num, i) => num === drawnNumbers[i]).length :
                        combo.filter(num => drawnNumbers.includes(num)).length;
                    
                    if (config.hasTrevos) {
                        const trevoHits = state.selectedTrevos.filter(t => drawnTrevos.includes(t)).length;
                        const tier = `${hits}+${trevoHits}`;
                        state.hitResults.push({ hits, trevoHits });
                        if (prizeCounts.hasOwnProperty(tier)) {
                            prizeCounts[tier]++;
                            totalPrizeMoney += config.prizeValues[tier] || 0;
                        }
                    } else {
                        state.hitResults.push({ hits });
                        if (prizeCounts.hasOwnProperty(hits)) {
                            prizeCounts[hits]++;
                            totalPrizeMoney += config.prizeValues[hits] || 0;
                        }
                    }
                });
                return { prizeCounts, totalPrizeMoney };
            }

            async function runAnalysis() {
                analysisLoadingSpinner.style.display = 'block';
                analysisResultsContainer.style.display = 'none';
                analysisResultsContainer.innerHTML = '';

                const config = lotteryConfigs[state.currentGameMode];
                const count = parseInt(contestCountInput.value) || 100;
                let validResults = [];

                console.log("Tentando análise com o db.json.");
                validResults = await getContestsForAnalysisFromLocalDB(config.apiName, count);

                if (validResults.length === 0) {
                    console.warn(`db.json vazio ou sem dados para ${config.apiName}. Tentando API da Caixa.`);
                    try {
                        const latestContestData = await fetchApiData(`https://servicebus2.caixa.gov.br/portaldeloterias/api/${config.apiName}`);
                        if (!latestContestData.numero) throw new Error("API primária falhou.");
                        
                        const latestContestNumber = latestContestData.numero;
                        const contestNumbersToFetch = Array.from({ length: count }, (_, i) => latestContestNumber - i).filter(n => n > 0);

                        const promises = contestNumbersToFetch.map(num => 
                            fetchApiData(`https://servicebus2.caixa.gov.br/portaldeloterias/api/${config.apiName}/${num}`)
                            .catch(e => { console.warn(`Falha ao buscar concurso ${num}:`, e.message); return null; })
                        );
                        const results = await Promise.all(promises);
                        validResults = results.filter(res => res && res.listaDezenas && res.listaDezenas.length > 0);

                    } catch (error) {
                        console.error("Falha na API da Caixa durante a análise.", error);
                    }
                }

                if (validResults.length > 0) {
                    const allDrawnNumbers = validResults.flatMap(res => res.listaDezenas.map(n => parseInt(n)));
                    const frequency = calculateFrequency(allDrawnNumbers);
                    const pairs = calculatePairs(validResults.map(r => r.listaDezenas.map(n => parseInt(n))));
                    const suggestions = generateSuggestions(frequency, config);
                    displayAnalysisResults(frequency, pairs, validResults.length, suggestions, config);
                } else {
                    analysisResultsContainer.innerHTML = `<div class="alert alert-danger">Nenhum dado de concurso válido foi encontrado para a análise.</div>`;
                    analysisResultsContainer.style.display = 'block';
                }
                analysisLoadingSpinner.style.display = 'none';
            }

            function calculateFrequency(numbers) {
                const freqMap = new Map();
                for (const num of numbers) {
                    freqMap.set(num, (freqMap.get(num) || 0) + 1);
                }
                return Array.from(freqMap.entries()).sort((a, b) => b[1] - a[1]);
            }

            function calculatePairs(results) {
                const pairMap = new Map();
                for (const result of results) {
                    if(!result || result.length < 2) continue;
                    const combos = getCombinations(result.sort((a,b) => a-b), 2);
                    for (const pair of combos) {
                        const key = `${pair[0].toString().padStart(2,'0')}-${pair[1].toString().padStart(2,'0')}`;
                        pairMap.set(key, (pairMap.get(key) || 0) + 1);
                    }
                }
                return Array.from(pairMap.entries()).sort((a, b) => b[1] - a[1]);
            }

            function generateSuggestions(frequency, config) {
                if (config.isColumnar) return null;

                const { betSize, totalNumbers } = config;
                
                const hotNumbers = frequency.slice(0, betSize).map(item => item[0]);

                const allPossibleNumbers = new Set(Array.from({ length: totalNumbers }, (_, i) => i + 1));
                const drawnNumbers = new Set(frequency.map(item => item[0]));
                const neverDrawn = [...allPossibleNumbers].filter(num => !drawnNumbers.has(num));
                const leastFrequent = frequency.slice(-totalNumbers).map(item => item[0]).reverse();
                const coldNumbers = [...neverDrawn, ...leastFrequent].slice(0, betSize);

                const half = Math.floor(betSize / 2);
                const mixedNumbers = [
                    ...hotNumbers.slice(0, betSize - half),
                    ...coldNumbers.slice(0, half)
                ];

                return {
                    hot: hotNumbers.sort((a, b) => a - b),
                    cold: coldNumbers.sort((a, b) => a - b),
                    mixed: mixedNumbers.sort((a, b) => a - b)
                };
            }

            // --- UTILITY & STATE MANAGEMENT ---
            function clearSelection() {
                state.selectedNumbers = [];
                state.fixedNumbers = [];
                state.selectedTrevos = [];
                state.superSeteSelections = [[],[],[],[],[],[],[]];
                document.querySelectorAll('.number-btn, .trevo-btn').forEach(btn => {
                    btn.classList.remove('active', 'btn-fixed');
                    btn.querySelector('.fa-thumbtack')?.remove();
                });
                updateSelectedNumbersDisplay(state.selectedNumbers, state.fixedNumbers, state.superSeteSelections, state.selectedTrevos, lotteryConfigs[state.currentGameMode]);
                hideResults();
                hideError();
                saveState();
            }

            function getSpecialSelections() {
                const config = lotteryConfigs[state.currentGameMode];
                let selections = { trevos: state.selectedTrevos };
                if (config.hasTeam) {
                    selections.team = document.getElementById('teamSelect').value;
                }
                if (config.hasMonth) {
                    selections.month = document.getElementById('monthSelect').value;
                }
                return selections;
            }
            
            function saveState() {
                const currentState = { ...state, ...getSpecialSelections() };
                localStorage.setItem('lotteryGeneratorState', JSON.stringify(currentState));
            }

            function restoreState() {
                const saved = localStorage.getItem('lotteryGeneratorState');
                if (!saved) return;
                
                const savedState = JSON.parse(saved);
                
                gameModeSelect.value = savedState.currentGameMode;
                updateUIForGameMode(savedState.currentGameMode);
                
                setTimeout(() => {
                    state = { ...state, ...savedState };
                    
                    updateSelectedNumbersDisplay(state.selectedNumbers, state.fixedNumbers, state.superSeteSelections, state.selectedTrevos, lotteryConfigs[state.currentGameMode]);
                    
                    if (state.generatedCombinations.length > 0) {
                        displayResults(state.generatedCombinations, state.totalCostValue, lotteryConfigs[state.currentGameMode], state.fixedNumbers, getSpecialSelections());
                    }
                    
                    if (lotteryConfigs[state.currentGameMode].isColumnar) {
                        document.querySelectorAll('#superSeteGridContainer .number-btn').forEach(btn => {
                            const num = parseInt(btn.dataset.number);
                            const col = parseInt(btn.dataset.column);
                            if (state.superSeteSelections[col] && state.superSeteSelections[col].includes(num)) {
                                btn.classList.add('active');
                            }
                        });
                    } else {
                        document.querySelectorAll('#numberGridContainer .number-btn').forEach(btn => {
                            const num = parseInt(btn.dataset.number);
                            if (state.selectedNumbers.includes(num)) btn.classList.add('active');
                            if (state.fixedNumbers.includes(num)) {
                                btn.classList.add('btn-fixed');
                                btn.innerHTML = `<span>${num.toString().padStart(2, '0')}</span><i class="fas fa-thumbtack"></i>`;
                            }
                        });
                    }

                    document.querySelectorAll('.trevo-btn').forEach(btn => {
                        const trevo = parseInt(btn.dataset.trevo);
                        if (state.selectedTrevos.includes(trevo)) {
                            btn.classList.add('active');
                        }
                    });

                    if (state.team && document.getElementById('teamSelect')) document.getElementById('teamSelect').value = state.team;
                    if (state.month && document.getElementById('monthSelect')) document.getElementById('monthSelect').value = state.month;

                }, 300);
            }

            // --- NEW --- Range Analysis Logic
            async function handleAnalyzeContestRange() {
                const startContestInput = document.getElementById('startContestInput');
                const endContestInput = document.getElementById('endContestInput');
                const resultContainer = document.getElementById('rangeHistoryAnalysisResult');

                const start = parseInt(startContestInput.value);
                const end = parseInt(endContestInput.value);
                const config = lotteryConfigs[state.currentGameMode];

                if (isNaN(start) || isNaN(end) || start <= 0 || end <= 0 || start > end) {
                    resultContainer.innerHTML = '<div class="alert alert-danger">Por favor, insira um intervalo de concursos válido.</div>';
                    resultContainer.classList.remove('d-none');
                    return;
                }
                
                resultContainer.innerHTML = `<div class="text-center"><div class="spinner-border text-info" role="status"></div> Analisando concursos de ${start} a ${end}...</div>`;
                resultContainer.classList.remove('d-none');

                let contestResults = await getContestsForAnalysisFromLocalDBByRange(config.apiName, start, end);
                
                // Fallback to API if local data is incomplete
                const fetchedContestNumbers = new Set(contestResults.map(c => c.numero));
                const missingContests = [];
                for (let i = start; i <= end; i++) {
                    if (!fetchedContestNumbers.has(i)) {
                        missingContests.push(i);
                    }
                }

                if (missingContests.length > 0) {
                    console.warn(`Faltando ${missingContests.length} concursos no db.json, buscando na API...`);
                    const promises = missingContests.map(num =>
                        fetchApiData(`https://servicebus2.caixa.gov.br/portaldeloterias/api/${config.apiName}/${num}`)
                        .catch(e => null)
                    );
                    const apiResults = (await Promise.all(promises)).filter(Boolean);
                    contestResults = [...contestResults, ...apiResults].sort((a,b) => a.numero - b.numero);
                }

                if (contestResults.length === 0) {
                    resultContainer.innerHTML = '<div class="alert alert-warning">Nenhum resultado encontrado para o intervalo informado.</div>';
                    return;
                }

                processAndDisplayRangeHistory(contestResults, config);
            }
            
            function processAndDisplayRangeHistory(results, config) {
                const resultContainer = document.getElementById('rangeHistoryAnalysisResult');
                const winningCombinations = new Map(); // combo_string -> { combo: [], count: 0, contests: [] }
                let totalPrizesInPeriod = 0;

                results.forEach(contest => {
                    const drawnNumbers = contest.listaDezenas.map(n => parseInt(n));
                    const drawnTrevos = contest.listaTrevosSorteados ? contest.listaTrevosSorteados.map(t => parseInt(t)) : [];
                    
                    state.generatedCombinations.forEach((combo, comboIndex) => {
                        let hits = config.isColumnar ?
                            combo.filter((num, i) => num === drawnNumbers[i]).length :
                            combo.filter(num => drawnNumbers.includes(num)).length;

                        let tier;
                        if (config.hasTrevos) {
                            const trevoHits = state.selectedTrevos.filter(t => drawnTrevos.includes(t)).length;
                            tier = `${hits}+${trevoHits}`;
                        } else {
                            tier = hits;
                        }

                        if (config.prizeTiers.includes(tier)) {
                            const comboKey = combo.join(',');
                            if (!winningCombinations.has(comboKey)) {
                                winningCombinations.set(comboKey, { combo: combo, count: 0, contests: [] });
                            }
                            const winInfo = winningCombinations.get(comboKey);
                            winInfo.count++;
                            winInfo.contests.push({num: contest.numero, tier: tier});
                            totalPrizesInPeriod += config.prizeValues[tier] || 0;
                        }
                    });
                });
                
                state.winningCombinationsInRange = Array.from(winningCombinations.values());

                let html = `<h5>Análise de ${results.length} concursos (${results[0].numero} a ${results[results.length - 1].numero})</h5>`;
                
                if (winningCombinations.size === 0) {
                    html += '<div class="alert alert-info mt-3">Nenhuma de suas combinações foi premiada neste período.</div>';
                    resultContainer.innerHTML = html;
                    return;
                }

                html += `
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <p class="mb-0"><strong>${winningCombinations.size}</strong> combinações premiadas encontradas. Total estimado em prêmios: <strong>${totalPrizesInPeriod.toLocaleString('pt-BR', {style: 'currency', currency: 'BRL'})}</strong></p>
                        <button class="btn btn-sm btn-outline-success" id="exportWinningCombosBtn"><i class="fas fa-file-export me-1"></i> Exportar Premiadas</button>
                    </div>
                `;

                html += '<div class="table-responsive mt-3" style="max-height: 400px;"><table class="table table-sm table-hover"><thead><tr><th>Combinação</th><th>Vezes Premiada</th><th>Concursos</th></tr></thead><tbody>';
                
                const sortedWinners = [...winningCombinations.values()].sort((a,b) => b.count - a.count);

                sortedWinners.forEach(({ combo, count, contests }) => {
                    const comboHtml = combo.map(n => `<span class="badge bg-secondary">${n.toString().padStart(2, '0')}</span>`).join(' ');
                    const contestsHtml = contests.map(c => `<span class="badge bg-light text-dark" title="Acertos: ${getTierText(c.tier, config)}">${c.num}</span>`).join(' ');
                    html += `<tr><td>${comboHtml}</td><td>${count}</td><td>${contestsHtml}</td></tr>`;
                });

                html += '</tbody></table></div>';
                resultContainer.innerHTML = html;
                
                document.getElementById('exportWinningCombosBtn').addEventListener('click', handleExportWinningCombinations);
            }
            
            function handleExportWinningCombinations() {
                const config = lotteryConfigs[state.currentGameMode];
                if (state.winningCombinationsInRange.length === 0) {
                    showError("Não há combinações premiadas para exportar.");
                    return;
                }
                
                let content = `Combinações Premiadas - ${config.displayName}\n`;
                content += `Análise entre os concursos ${document.getElementById('startContestInput').value} e ${document.getElementById('endContestInput').value}\n\n`;

                state.winningCombinationsInRange.forEach(({ combo, count, contests }) => {
                    content += `Combinação: ${combo.join(' ')}\n`;
                    content += `Premiada ${count} vez(es) nos concursos: ${contests.map(c => c.num).join(', ')}\n\n`;
                });

                const blob = new Blob([content], { type: 'text/plain;charset=utf-8;' });
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `${config.apiName}_premiadas.txt`;
                document.body.appendChild(a);
                a.click();
                window.URL.revokeObjectURL(url);
                document.body.removeChild(a);
            }
            
            // NOVA FUNÇÃO PARA BUSCAR DADOS DOS PRÓXIMOS CONCURSOS
            async function fetchUpcomingContests() {
                const container = document.getElementById('upcomingContestsContainer');
                container.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                        <p class="mt-2">Carregando informações...</p>
                    </div>`;

                try {
                    const response = await fetch('loterias.json');
                    if (!response.ok) {
                        throw new Error('Não foi possível carregar o arquivo loterias.json');
                    }
                    const data = await response.json();

                    let html = '<div class="row g-3">';

                    for (const gameKey in lotteryConfigs) {
                        const config = lotteryConfigs[gameKey];
                        const contestData = data[config.apiName];

                        if (contestData && contestData.dataProximoConcurso && contestData.valorEstimadoProximoConcurso > 0) {
                            const [year, month, day] = contestData.dataProximoConcurso.split('T')[0].split('-');
                            const formattedDate = `${day}/${month}/${year}`;
                            const formattedValue = contestData.valorEstimadoProximoConcurso.toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' });

                            html += `
                                <div class="col-md-6">
                                    <div class="card h-100" style="border-left: 4px solid ${config.color};">
                                        <div class="card-body">
                                            <h5 class="card-title" style="color: ${config.color};">${config.displayName}</h5>
                                            <p class="card-text mb-1">
                                                <i class="fas fa-calendar-day me-2"></i>
                                                <strong>Próximo Sorteio:</strong> ${formattedDate}
                                            </p>
                                            <p class="card-text mb-0">
                                                <i class="fas fa-dollar-sign me-2"></i>
                                                <strong>Prêmio Estimado:</strong> ${formattedValue}
                                            </p>
                                        </div>
                                    </div>
                                </div>
                            `;
                        }
                    }

                    html += '</div>';
                    container.innerHTML = html;

                } catch (error) {
                    console.error('Erro ao buscar próximos concursos:', error);
                    container.innerHTML = `<div class="alert alert-danger">Não foi possível carregar as informações dos próximos concursos. Verifique se o arquivo <strong>loterias.json</strong> está no mesmo diretório do seu projeto.</div>`;
                }
            }

            initializeApp();
        });
    </script>
</body>
</html>
